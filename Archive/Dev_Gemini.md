# StartDeck 开发规范分析报告 (Dev_Gemini.md)

基于对 `Dev.md` 的深入分析，以下是关于技术选型和细节的评估报告。

## 1. 技术选型评估 (Technical Stack)

| 选型 | 评估 | 详细分析 |
| :--- | :--- | :--- |
| **.NET 8 + WinUI 3** | **✅ 优秀** | 这是开发 Windows 11 原生风格应用的最佳组合。WinUI 3 提供了现代化的控件和渲染管线，.NET 8 提供了高性能运行时。**可行性高。** |
| **Native AOT** | **⚠️ 挑战** | **优点：** 启动极快，无依赖，单一 EXE，防反编译。这是实现“轻量级”目标的关键。<br>**挑战：** 很多传统的 .NET 库（尤其是序列化、依赖注入容器）在 AOT 下不可用或需特殊处理。**这要求我们在开发中必须时刻关注 AOT 兼容性。** |
| **零依赖原则** | **✅ 推荐** | 配合 AOT 使用非常明智。减少第三方 NuGet 包可以显著降低 AOT 裁剪失败的风险，并减小最终体积。 |

## 2. 核心模块细节分析 (Pros & Cons)

### 2.1 启动与进程管理 (Lifecycle)
*   **✅ 可取：** 使用 `Mutex` 做单例检查，使用命名管道（IPC）做唤醒机制。这是行业标准做法，稳定可靠。
*   **⚠️ 改进点：** 文档提到了“热唤醒”时现有进程退出。**更好的做法是**：新进程只负责发送信号然后退出，**旧进程（常驻进程）负责接收信号并显示窗口**。这样可以避免常驻进程频繁重启，保持内存热度。

### 2.2 数据扫描 (Scanner)
*   **✅ 可取：** 采用**策略模式** (`IAppFilter`, `IAppSource`)。这种设计非常棒，未来如果想支持 Steam 游戏或 UWP 应用，只需添加新的 `Source` 实现类，无需修改核心逻辑。
*   **❌ 潜在漏洞：** **LNK 解析**。文档暗示要“零依赖”，但 LNK 文件格式极其复杂（二进制）。如果不使用 `Windows Script Host` (COM) 或第三方库，手写解析器极易出错且维护成本高。
*   **💡 改进建议：** 建议使用 .NET 8 的 **Source-Generated COM Interop** (`ComWrappers`) 来调用系统的 `IShellLink` 接口。这样既能保持 AOT 兼容，又能利用系统原生的解析能力，无需手写二进制解析器。

### 2.3 图标处理 (Icon Engine)
*   **✅ 可取：** 异步加载和内存缓存是必须的。
*   **⚠️ 风险：** 文档提到 `Dictionary<FilePath, BitmapImage>`。在 WinUI 3 中，`BitmapImage` 通常只能在 UI 线程创建和访问。如果在后台线程直接创建 `BitmapImage` 可能会抛出线程异常。
*   **💡 改进建议：** 后台线程应提取为 `byte[]` 或 `IStream`，仅在数据传递给 View 时（或在 ViewModel 的 UI 线程上下文中）转换为 `BitmapImage`。或者确保使用 `DispatcherQueue` 调度到 UI 线程创建图片。

### 2.4 UI/UX 实现
*   **✅ 可取：** 强制 `MicaAlt` 并在旧系统降级，这保证了视觉体验的下限。
*   **⚠️ 难点：** “动态获取任务栏位置”和“多显示器适配”。这部分需要大量 P/Invoke (`user32.dll`)，代码量会比较大且容易出 Bug（例如处理负坐标、DPI 缩放后的坐标转换）。需要仔细测试。

## 3. 总体评价与总结

*   **可行性：** **高**。该文档描述的架构清晰、逻辑自洽，完全可以落地。
*   **最大亮点：** **Native AOT + 策略模式**。既保证了性能，又预留了极佳的代码扩展性。
*   **最大风险：** **Win32 API 集成**。由于追求零依赖和原生体验，大量功能（LNK解析、图标提取、窗口定位、任务栏检测）都需要直接调用 Win32 API。这不仅增加了开发难度，也增加了出错的概率。

## 4. 关键改进建议 (Actionable Advice)

1.  **LNK 解析方案：** 不要手写二进制解析。使用 `.NET 8 ComWrappers` + `IShellLink`。
2.  **IPC 逻辑微调：** 保持常驻进程不退出，新进程发送信号后退出。
3.  **图标线程安全：** 在缓存层和 UI 层之间建立明确的线程调度边界，防止 `RPC_E_WRONG_THREAD` 错误。
4.  **虚拟化列表：** 建议**默认开启** UI 虚拟化（Virtualization），而不仅是超过 100 个才开启，因为 WinUI 的 `ListView` 虚拟化性能很好，且能显著降低内存峰值。
