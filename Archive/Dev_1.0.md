这份文档旨在确立 **StartDeck** 的工程地基。它不纠结于具体的变量命名，而是规定**架构模式、交互原则与扩展接口**。遵循此文档，可以确保软件在未来迭代中保持代码的整洁、高性能与可维护性。

---

# StartDeck 架构与开发规范指南 (v1.0)

## 1. 架构总览 (Architecture Overview)

### 1.1 核心设计模式
采用标准的 **MVVM (Model-View-ViewModel)** 架构。
*   **Model (数据层):** 负责文件系统的 I/O 操作、LNK 解析、图标提取。严禁包含任何 UI 代码。
*   **ViewModel (逻辑层):** 负责数据的清洗、分组、状态管理。它是 UI 与数据的桥梁，必须实现 `INotifyPropertyChanged` 接口。
*   **View (表现层):** 纯 XAML 定义的 WinUI 3 界面。除了极少量的窗口句柄操作（P/Invoke），应避免在 Code-Behind 中编写业务逻辑。

### 1.2 技术栈约束
*   **框架:** .NET 8 + Windows App SDK (WinUI 3)
*   **发布模式:** Native AOT (必须严格遵守 AOT 的裁剪规则，禁止使用严重依赖反射的第三方库)。
*   **依赖管理:** 零依赖原则。除官方库外，尽量不引入 NuGet 包，以确保体积最小化。

---

## 2. 核心模块设计原则

### 2.1 启动与进程管理模块 (Lifecycle Manager)
**原则：单例互斥，信号驱动。**
*   **互斥锁机制：** 程序启动时必须检查 `Mutex` 或命名管道。
*   **信号协议：** 定义一套轻量级的 IPC (进程间通信) 协议。
    *   *场景 A (冷启动):* 无现有进程 -> 初始化 -> 驻留后台 -> 显示窗口。
    *   *场景 B (热唤醒):* 有现有进程 -> 发送 "Show" 指令 -> 现有进程响应 -> 当前进程退出。
*   **扩展性预留：** 通信协议应支持参数传递（例如：未来支持命令行参数 `startdeck.exe --search "chrome"` 直接呼出并搜索）。

### 2.2 数据扫描模块 (Scanner Service)
**原则：只读操作，异常吞没，策略模式。**
*   **容错性：** 文件系统是不可靠的（快捷方式可能指向不存在的文件）。扫描器必须包裹在 `Try-Catch` 中，遇到损坏的 LNK 文件应跳过而不是崩溃。
*   **过滤器接口 (`IAppFilter`)：** 不要把过滤逻辑写死。应定义一个过滤器接口，允许链式处理。
    *   *当前实现：* `NameFilter` (过滤 Uninstall), `ExtensionFilter` (只留 .lnk)。
    *   *未来扩展：* 可以轻松添加 `CategoryFilter` (按类别过滤) 或 `UsageFilter` (按使用频率过滤)。
*   **数据源接口 (`IAppSource`)：**
    *   *当前实现：* `FileSystemSource` (读取开始菜单)。
    *   *未来扩展：* 可实现 `SteamSource` (读取 Steam 游戏)、`UWPAppSource` (读取商店应用)，统一聚合到主界面。

### 2.3 图标处理模块 (Icon Engine)
**原则：按需加载，内存缓存，异步处理。**
*   **异步加载：** 图标提取是耗时操作（涉及磁盘 I/O 和 GDI+ 绘图）。必须在后台线程完成，禁止阻塞 UI 线程。
*   **缓存策略：**
    *   建立 `Dictionary<FilePath, BitmapImage>` 缓存池。
    *   **生命周期：** 窗口隐藏时，不立即销毁缓存（为了下次秒开）；但需监听系统内存警告，必要时释放缓存。
*   **降级方案：** 当无法提取图标时，必须返回一个内置的“通用可执行文件”默认图标，确保 UI 不会出现空白。

---

## 3. UI/UX 实现规范

### 3.1 窗口行为 (Windowing)
*   **无感化：** 窗口在初始化时应设为不可见，待数据加载完毕且布局计算完成后，再执行“显示”动作，避免用户看到界面闪烁或布局跳变。
*   **定位算法：**
    *   必须动态获取当前任务栏的位置（上/下/左/右）和尺寸。
    *   必须处理多显示器环境，确保窗口弹出在用户点击图标所在的那个屏幕上。
*   **焦点管理：** 必须实现全局鼠标钩子或窗口失焦事件 (`Deactivated`)。逻辑是：任何在窗口外部的点击 = `Hide()`。

### 3.2 视觉一致性 (Visual Consistency)
*   **材质：** 强制使用 `MicaAlt`。如果系统版本不支持（如 Win10），降级为 `Acrylic` 或纯色，严禁 Crash。
*   **主题自适应：** 严禁硬编码颜色值（如 `#FFFFFF`）。必须使用 WinUI 的 `ThemeResource`（如 `SystemControlPageTextBaseHighBrush`），以自动适配系统的亮色/暗色模式。
*   **高分屏 (High DPI)：** 所有尺寸定义必须使用逻辑像素，图标资源需准备多倍图或使用矢量图（SVG/FontIcon）。

---

## 4. 性能与优化标准

### 4.1 内存管理
*   **Bitmap 处理：** 提取的图标对象在不使用时必须显式 Dispose，因为 GDI 对象不由 .NET GC 直接管理，容易造成内存泄漏。
*   **集合视图：** 对于应用列表，使用 `ObservableCollection`。如果数量超过 100 个，UI 层必须开启 `Virtualization` (虚拟化回收)，只渲染可视区域的图标。

### 4.2 启动速度
*   **AOT 兼容性：** 所有的反射代码（Reflection）必须有明确的元数据声明，否则 AOT 编译会失败。
*   **冷启动阈值：** 从点击图标到界面完全渲染，耗时不得超过 **200ms**。
*   **预热机制：** 首次运行后，数据应驻留内存。

---

## 5. 未来扩展性规划 (Roadmap Proofing)

在编写代码时，请为以下未来可能的功能预留接口或代码结构：

1.  **搜索功能：** ViewModel 中预留 `SearchText` 属性和 `Filter` 方法，虽然 MVP 版本可能不显示搜索框，但底层逻辑应支持实时筛选。
2.  **自定义排序：** 目前是自动排序。未来可能需要支持“固定(Pin)”或“拖拽排序”。数据模型中应预留 `OrderIndex` 或 `IsPinned` 字段。
3.  **插件化：** 虽然现在是单体应用，但各模块（扫描、渲染、交互）应保持低耦合。如果未来想把这个做成一个平台，允许开发者写插件（例如显示“天气小组件”），现在的代码结构不应成为阻碍。

---

## 6. 开发自检清单 (Definition of Done)

在提交代码或发布版本前，必须通过以下检查：
*   [ ] **AOT 检查：** 是否能在 Native AOT 模式下编译通过且无运行时异常？
*   [ ] **DPI 检查：** 在 100%, 125%, 150% 缩放比例下，界面是否模糊或错位？
*   [ ] **多屏检查：** 在副显示器点击任务栏，窗口是否正确弹出在副屏？
*   [ ] **泄漏检查：** 反复开关窗口 50 次，内存占用是否稳定（无持续增长）？
*   [ ] **路径检查：** 是否能正确处理包含中文、空格或特殊字符的软件路径？